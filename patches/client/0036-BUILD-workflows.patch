From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: way-zer <himc.wicp@gmail.com>
Date: Sun, 3 Mar 2024 16:54:20 +0800
Subject: [PATCH] BUILD workflows

---
 .github/workflows/build.yml      | 61 +++++++++++++++++++++
 .github/workflows/deployment.yml | 93 --------------------------------
 .github/workflows/pr.yml         | 28 ----------
 .github/workflows/push.yml       | 61 ---------------------
 4 files changed, 61 insertions(+), 182 deletions(-)
 create mode 100644 .github/workflows/build.yml
 delete mode 100644 .github/workflows/deployment.yml
 delete mode 100644 .github/workflows/pr.yml
 delete mode 100644 .github/workflows/push.yml

diff --git a/.github/workflows/build.yml b/.github/workflows/build.yml
new file mode 100644
index 0000000000000000000000000000000000000000..10f800a3a57e1f0c19513526e27d940e6b22aa26
--- /dev/null
+++ b/.github/workflows/build.yml
@@ -0,0 +1,61 @@
+name: Build Artifacts
+
+on:
+  push:
+    branches:
+      - '*'
+  workflow_dispatch:
+
+jobs:
+  deploy:
+    runs-on: ubuntu-latest
+
+    steps:
+      - uses: actions/checkout@v2
+      - name: Set up JDK 17
+        uses: actions/setup-java@v4
+        with:
+          distribution: 'temurin'
+          java-version: 17
+      - name: Setup Gradle
+        uses: gradle/actions/setup-gradle@v3
+        with:
+          gradle-version: 8.6
+          cache-read-only: false
+          build-scan-publish: true
+          build-scan-terms-of-use-url: "https://gradle.com/help/legal-terms-of-use"
+          build-scan-terms-of-use-agree: "yes"
+      - name: Set env
+        run: |
+          echo "RELEASE_TAG=${GITHUB_REF_NAME}-build" >> $GITHUB_ENV
+          echo "RELEASE_TAG=${GITHUB_REF_NAME}-build"
+          echo "RELEASE_VERSION=$(date +'%Y.%m.%d').${GITHUB_RUN_NUMBER}-${GITHUB_REF_NAME}" >> $GITHUB_ENV
+          
+          echo "${{ secrets.KEYSTORE_BASE64 }}" > keystore.txt
+          openssl enc -d -base64 -in keystore.txt -out ../bekeystore.jks
+      - name: Create artifacts
+        env:
+          keystore_password: ${{ secrets.KEYSTORE_PASSWORD_SECRET }}
+          keystore_alias_password: ${{ secrets.KEYSTORE_PASSWORD_SECRET }}
+          keystore_alias: MindustryX
+        run: |
+          gradle desktop:dist core:genLoaderModAll android:assembleRelease -Pbuildversion=${RELEASE_VERSION}
+      - name: Move artifacts
+        run: |
+          mkdir artifacts
+          mv desktop/build/libs/Mindustry.jar artifacts/MindustryX-${{env.RELEASE_VERSION}}-Desktop.jar
+          mv core/build/distributions/MindustryX.loader.dex.jar artifacts/MindustryX-${{env.RELEASE_VERSION}}.loader.dex.jar
+          mv android/build/outputs/apk/release/android-release.apk artifacts/MindustryX-${{env.RELEASE_VERSION}}-Android.apk
+      - name: Update Tag
+        uses: rickstaa/action-create-tag@v1
+        with:
+          tag: ${{ env.RELEASE_TAG }}
+          force_push_tag: true
+      - name: Release
+        uses: softprops/action-gh-release@v2.0.2
+        with:
+          tag_name: ${{ env.RELEASE_TAG }}
+          name: ${{ env.RELEASE_VERSION }}
+          target_commitish: ${{github.sha}}
+          files: artifacts/*
+          prerelease: true
diff --git a/.github/workflows/deployment.yml b/.github/workflows/deployment.yml
deleted file mode 100644
index 224a753d655956445b2f885b0ea7ace56de4bbd5..0000000000000000000000000000000000000000
--- a/.github/workflows/deployment.yml
+++ /dev/null
@@ -1,93 +0,0 @@
-name: Deployment
-
-on:
-  push:
-    tags:
-      - 'v*'
-
-permissions: {}
-jobs:
-  deploy:
-    permissions:
-      contents: write # for release creation (svenstaro/upload-release-action)
-
-    runs-on: ubuntu-latest
-
-    steps:
-    - uses: actions/checkout@v2
-    - name: Set up JDK 17
-      uses: actions/setup-java@v1
-      with:
-        java-version: 17
-    - name: Set env
-      run: echo "RELEASE_VERSION=${GITHUB_REF#refs/*/}" >> $GITHUB_ENV
-    - name: Add Arc release
-      run: |
-        git config --global user.email "actions@github.com"
-        git config --global user.name "Github Actions"
-        git clone --depth=1 --branch=master https://github.com/Anuken/Arc ../Arc
-        cd ../Arc
-        git tag ${RELEASE_VERSION}
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/Arc ${RELEASE_VERSION};
-        cd ../Mindustry
-    - name: Update JITpack repo
-      run: |
-        cd ../
-        cp -r ./Mindustry ./MindustryJitpack
-        cd MindustryJitpack
-        git config --global user.name "Github Actions"
-        git config --global user.email "actions@github.com"
-        git clone --depth 1 https://github.com/Anuken/MindustryJitpack.git
-        rm -rf .git
-        cp -r ./MindustryJitpack/.git ./.git
-        rm -rf MindustryJitpack
-        rm -rf .github
-        rm README.md
-        git add .
-        git commit --allow-empty -m "Updating"
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/MindustryJitpack
-        git tag ${RELEASE_VERSION}
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/MindustryJitpack
-        cd ../Mindustry
-    - name: Create artifacts
-      run: |
-        ./gradlew desktop:dist server:dist core:mergedJavadoc -Pbuildversion=${RELEASE_VERSION:1}
-    - name: Update docs
-      run: |
-        cd ../
-        git config --global user.email "cli@github.com"
-        git config --global user.name "Github Actions"
-        git clone --depth=1 https://github.com/MindustryGame/docs.git
-        cd docs
-        find . -maxdepth 1 ! -name ".git" ! -name . -exec rm -r {} \;
-        cd ../
-        cp -a Mindustry/core/build/javadoc/. docs/
-        cd docs
-        git add .
-        git commit --allow-empty -m "Update ${RELEASE_VERSION:1}"
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/MindustryGame/docs
-        cd ../Mindustry
-    - name: Update F-Droid build string
-      run: |
-        git clone --depth=1 --branch=master https://github.com/Anuken/MindustryBuilds ../MindustryBuilds
-        cd ../MindustryBuilds
-        echo "Updating version to ${RELEASE_VERSION:1}"
-        BNUM=$(($GITHUB_RUN_NUMBER + 1000))
-        echo versionName=7-fdroid-${RELEASE_VERSION:1}$'\n'versionCode=${BNUM} > version_fdroid.txt
-        git add .
-        git commit -m "Updating to build ${RELEASE_VERSION:1}"
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/MindustryBuilds
-        cd ../Mindustry
-    - name: Upload client artifacts
-      uses: svenstaro/upload-release-action@v2
-      with:
-        repo_token: ${{ secrets.GITHUB_TOKEN }}
-        file: desktop/build/libs/Mindustry.jar
-        tag: ${{ github.ref }}
-    - name: Upload server artifacts
-      uses: svenstaro/upload-release-action@v2
-      with:
-        repo_token: ${{ secrets.GITHUB_TOKEN }}
-        file: server/build/libs/server-release.jar
-        tag: ${{ github.ref }}
-
diff --git a/.github/workflows/pr.yml b/.github/workflows/pr.yml
deleted file mode 100644
index eb2dcff192d52a8515331a2f058e86c65c0ae98b..0000000000000000000000000000000000000000
--- a/.github/workflows/pr.yml
+++ /dev/null
@@ -1,28 +0,0 @@
-name: Pull Request Tests
-
-on: [pull_request, workflow_dispatch]
-
-permissions:
-  contents: read # to fetch code (actions/checkout)
-
-jobs:
-  testPR:
-    runs-on: ubuntu-latest
-
-    steps:
-    - uses: actions/checkout@v2
-    - name: Set up JDK 17
-      uses: actions/setup-java@v1
-      with:
-        java-version: 17
-    - name: Setup Gradle
-      uses: gradle/gradle-build-action@v2
-    - name: Run unit tests
-      run: ./gradlew tests:test --stacktrace --rerun
-    - name: Run unit tests and build JAR
-      run: ./gradlew desktop:dist
-    - name: Upload desktop JAR for testing
-      uses: actions/upload-artifact@v2
-      with:
-        name: Desktop JAR (zipped)
-        path: desktop/build/libs/Mindustry.jar
diff --git a/.github/workflows/push.yml b/.github/workflows/push.yml
deleted file mode 100644
index cd593a6dfdf55b4e70e548ab1d96f64d5354056d..0000000000000000000000000000000000000000
--- a/.github/workflows/push.yml
+++ /dev/null
@@ -1,61 +0,0 @@
-name: Tests
-
-on: [push, workflow_dispatch]
-
-permissions: {}
-jobs:
-  runPush:
-    permissions:
-      contents: write # for Update bundles
-
-    runs-on: ubuntu-latest
-
-    steps:
-    - uses: actions/checkout@v2
-    - name: Trigger BE build
-      if: ${{ github.repository == 'Anuken/Mindustry' }}
-      run: |
-        git clone --depth=1 --branch=master https://github.com/Anuken/MindustryBuilds ../MindustryBuilds
-        cd ../MindustryBuilds
-        BNUM=$(($GITHUB_RUN_NUMBER + 20000))
-        git tag ${BNUM}
-        git config --global user.name "Github Actions"
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/MindustryBuilds ${BNUM}
-    - name: Set up JDK 17
-      uses: actions/setup-java@v1
-      with:
-        java-version: 17
-    - name: Setup Gradle
-      uses: gradle/gradle-build-action@v2
-    - name: Update bundles
-      if: ${{ github.repository == 'Anuken/Mindustry' }}
-      run: |
-        ./gradlew updateBundles
-
-        if [ -n "$(git status --porcelain)" ]; then
-          git config --global user.name "Github Actions"
-          git config --global user.email "actions@github.com"
-          git add core/assets/bundles/*
-          git commit -m "Automatic bundle update"
-          git push
-        fi
-    - name: Update JITpack repo
-      if: ${{ github.repository == 'Anuken/Mindustry' }}
-      run: |
-        git config --global user.name "Github Actions"
-        git config --global user.email "actions@github.com"
-        cd ../
-        cp -r ./Mindustry ./MindustryJitpack
-        cd MindustryJitpack
-        git clone --depth 1 https://github.com/Anuken/MindustryJitpack.git
-        rm -rf .git
-        cp -r ./MindustryJitpack/.git ./.git
-        rm -rf MindustryJitpack
-        rm -rf .github
-        rm README.md
-        git add .
-        git commit --allow-empty -m "Updating"
-        git push https://Anuken:${{ secrets.API_TOKEN_GITHUB }}@github.com/Anuken/MindustryJitpack
-        cd ../Mindustry
-    - name: Run unit tests
-      run: ./gradlew tests:test --rerun --stacktrace
